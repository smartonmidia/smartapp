<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel de Exibi√ß√£o</title>

    <!-- Firebase Compat (v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <style>
        /* layout base */
        
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background: #000;
            overflow: hidden;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            box-sizing: border-box;
        }
        
        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }
        
        #wrapper {
            display: flex;
            width: 100vw;
            height: 100vh;
            flex-direction: row;
            transition: all .5s ease-in-out;
        }
        
        body.rotated #wrapper {
            flex-direction: column;
            transform: rotate(90deg) translateY(-100%);
            transform-origin: top left;
            width: 100vh;
            height: 100vw;
            position: absolute;
        }
        /* √°rea de m√≠dia */
        
        #superior {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            flex: 1;
            background: #000;
            width: 100%;
            height: 100%;
            padding-bottom: 60px;
            /* reserva para rodap√© */
        }
        
        #superior .media-wrap {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        
        .rodape {
            background: #fff;
            display: flex;
            align-items: center;
            padding: 1rem;
            color: #333;
            font-weight: 500;
            font-size: 1.1rem;
            box-sizing: border-box;
            z-index: 9999;
            transition: all .25s ease;
        }
        
        body:not(.rotated) .rodape {
            height: 60px;
            width: 100vw;
            position: fixed;
            bottom: 0;
            left: 0;
            flex-direction: row;
            justify-content: space-between;
            z-index: 9999;
        }
        
        body.rotated .rodape {
            width: 60px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            z-index: 9999;
        }
        
        body.rotated #superior {
            padding-left: 60px;
        }
        
        body.rotated .frase,
        body.rotated .info {
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        
        .frase,
        .info {
            white-space: nowrap;
        }
        
        .info {
            display: flex;
            flex-direction: column;
            font-size: 1rem;
            gap: 4px;
            text-align: right;
            align-items: flex-end;
        }
        
        .texto {
            background: transparent;
            color: #fff;
            font-size: 2rem;
            padding: 2rem;
            white-space: pre-wrap;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            text-align: left;
            line-height: 1.5;
            overflow: auto;
        }
        
        .imagem,
        .video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        /* transi√ß√µes sutis (find in / find out) */
        
        .fade {
            opacity: 0;
            transform: translateY(6px) scale(0.998);
            filter: blur(0.6px);
            transition: opacity 480ms cubic-bezier(.22, .95, .26, 1), transform 480ms cubic-bezier(.22, .95, .26, 1), filter 480ms;
            position: absolute;
            width: 100%;
            height: 100%;
            will-change: opacity, transform, filter;
        }
        
        .active {
            opacity: 1;
            transform: translateY(0) scale(1);
            filter: blur(0);
            z-index: 1;
        }
        /* Responsividade autom√°tica para m√≠dias em #superior */
        
        #superior>* {
            position: absolute !important;
            inset: 0;
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
        }
        
        #superior img,
        #superior video,
        #superior .imagem,
        #superior .video {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain !important;
            object-position: center center !important;
            display: block;
            margin: 0 auto;
            position: relative !important;
            background: black;
        }
        
        #superior iframe {
            width: 100% !important;
            height: 100% !important;
            transform-origin: center center;
            border: 0;
        }
        
        #superior .texto {
            padding: 2rem !important;
            overflow: auto !important;
            background: transparent !important;
            color: #fff !important;
        }
        
        body.rotated #superior>* {
            position: absolute !important;
            inset: 0;
            width: 100% !important;
            height: 100% !important;
        }
        /* overlay carregando */
        
        #carregandoOverlay {
            position: fixed;
            inset: 0;
            background: #0c0c0c;
            display: none;
            /* controlado via JS */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            color: #e0e6ed;
            font-family: "Roboto Mono", "Consolas", monospace;
            text-align: center;
            transition: opacity 600ms cubic-bezier(.22, .95, .26, 1);
            will-change: opacity;
        }
        
        #logoCarregando {
            width: 420px;
            margin-bottom: 28px;
            opacity: 0.98;
            transition: opacity 700ms ease;
        }
        
        .brilho {
            animation: brilho 2.2s ease-in-out infinite;
        }
        
        @keyframes brilho {
            0%,
            100% {
                opacity: .75
            }
            50% {
                opacity: 1
            }
        }
        
        .pontos {
            display: inline-block;
            width: auto;
            height: 2em;
            text-align: left;
            position: relative;
            margin-right: 8px;
            letter-spacing: -8px;
        }
        
        .pontos .dot {
            font-size: 1.4em;
            opacity: 0;
            transition: opacity 120ms linear;
            color: #9fded6;
        }
        
        .pontos .dot.on {
            opacity: 1;
        }
        
        .fadeOutShort {
            opacity: 0 !important;
            transition: opacity 360ms ease;
        }
        /* ========== Modal UID (empresaId) ========== */
        
        #uidModal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            background: rgba(0, 0, 0, 1);
            /* <-- fundo PRETO s√≥lido atr√°s do modal */
            visibility: hidden;
            opacity: 0;
            transition: opacity 260ms cubic-bezier(.22, .95, .26, 1), visibility 260ms;
        }
        
        #uidModal.show {
            visibility: visible;
            opacity: 1;
        }
        
        #uidModal .box {
            background: linear-gradient(180deg, #07111a 0%, #04131a 100%);
            color: #fff;
            padding: 26px;
            border-radius: 12px;
            width: min(720px, 92%);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            text-align: center;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            transform: translateY(8px) scale(.996);
            transition: transform 260ms cubic-bezier(.22, .95, .26, 1), box-shadow 260ms;
        }
        
        #uidModal.show .box {
            transform: translateY(0) scale(1);
        }
        
        #uidModal h2 {
            margin: 0 0 10px 0;
            font-size: 1.35rem;
            font-weight: 700;
        }
        
        #uidModal p {
            margin: 0 0 16px 0;
            color: #bcd3ea;
        }
        
        #empresaIdInput {
            width: 100%;
            padding: 12px 14px;
            font-size: 1.05rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(255, 255, 255, 0.02);
            color: #f0f7ff;
            outline: none;
            box-sizing: border-box;
            margin-bottom: 12px;
        }
        
        #uidButtons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            border: none;
        }
        
        .btn.primary {
            background: #ff6a00;
            color: #fff;
        }
        
        .btn.ghost {
            background: transparent;
            color: #e0e6ed;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }
        /* carrega texto maior */
        
        #carregandoTexto {
            font-size: 2.8rem;
            font-weight: 700;
        }
        
        #frase {
            font-size: 1.15rem;
        }
        
        .pontos .dot {
            font-size: 1.6rem;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <div id="superior" class="quadrante"></div>
    </div>

    <div class="rodape">
        <div class="frase" id="fraseRodape">Seja Bem Vindo!</div>
        <div class="info">
            <div id="infoRodape">üìÖ 00/00/0000 - üïí 00:00</div>
            <div class="tempo" id="tempoRodape"><span id="cidadeClima">Carregando clima...</span></div>
        </div>
    </div>

    <!-- Modal UID (empresaId) -->
    <div id="uidModal" role="dialog" aria-modal="true" aria-labelledby="uidTitle" aria-describedby="uidDesc">
        <div class="box" role="document">
            <h2 id="uidTitle">Informe o UID (empresaId)</h2>
            <p id="uidDesc">Digite o UID/empresaId para carregar as m√≠dias e configura√ß√µes desta empresa.</p>
            <input id="empresaIdInput" type="text" placeholder="Ex: UID90909090" />
            <div id="uidButtons">
                <button id="btnCancelarModal" class="btn ghost" type="button">Cancelar</button>
                <button id="btnConfirmModal" class="btn primary" type="button">OK</button>
            </div>
        </div>
    </div>

    <!-- TELA DE CARREGAMENTO -->
    <div id="telaCarregamento" aria-hidden="true">
        <div id="conteudoCarregamento">
            <img src="./audio/logo.png" alt="Logo" id="logoCarregamento">
            <div id="textoTerminal"></div>
            <div id="cursorTerminal">‚ñà</div>
        </div>
    </div>

    <div id="carregandoOverlay" aria-live="polite" role="status" aria-hidden="true">
        <img id="logoCarregando" src="./audio/logo.png" alt="Logo" />
        <div id="carregandoTexto" class="brilho">
            <span id="frase" aria-hidden="true">&gt;Iniciando sistema</span>
            <span class="pontos" aria-hidden="true" id="pontos">
                <span class="dot" id="dot1">.</span>
            <span class="dot" id="dot2">.</span>
            <span class="dot" id="dot3">.</span>
            </span>
        </div>
    </div>

    <script>
        /* ---------- Firebase init (compat) ---------- */
        const firebaseConfig = {
            apiKey: "AIzaSyDE1V9V4w0YbqJBgkeI7F4fN3sW_YokVBQ",
            authDomain: "midiaindoor-d2109.firebaseapp.com",
            databaseURL: "https://midiaindoor-d2109-default-rtdb.firebaseio.com",
            projectId: "midiaindoor-d2109",
            storageBucket: "midiaindoor-d2109.appspot.com",
            messagingSenderId: "549200922225",
            appId: "1:549200922225:web:731664468eb51fbdf2bdd0"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const firestore = (typeof firebase.firestore === 'function') ? firebase.firestore() : null;
        const db = firestore;

        function resolvePainelId() {
            const q = getQueryParam('painel') || getQueryParam('id') || getQueryParam('panel');
            return q || localStorage.getItem('painelId') || 'painel-default';
        }

        /* ---------- carregarDados: Firestore -> fallback RTDB ---------- */
        async function carregarDados(colecao, empresaId) {
            if (!empresaId) {
                console.error('empresaId ausente ao carregar dados da cole√ß√£o', colecao);
                return [];
            }

            // 1) Firestore
            if (db) {
                try {
                    const ref = db.collection('empresas').doc(empresaId).collection(colecao);
                    const snapshot = await ref.get();
                    const itens = [];
                    snapshot.forEach(doc => {
                        const data = doc.data() || {};
                        data._id = doc.id;
                        data.ordem = Number(data.ordem) || 0;
                        itens.push(data);
                    });
                    itens.sort((a, b) => a.ordem - b.ordem);
                    if (itens.length) return itens;
                } catch (err) {
                    console.warn('Erro Firestore (continuando fallback RTDB):', err);
                }
            }

            // 2) Realtime Database
            try {
                const ref = firebase.database().ref(`empresas/${empresaId}/${colecao}`);
                const snapshot = await ref.orderByChild('ordem').once('value');
                const items = [];
                snapshot.forEach(childSnap => {
                    const v = childSnap.val() || {};
                    items.push({
                        id: childSnap.key,
                        ...v,
                        ordem: Number(v.ordem) || 0
                    });
                });
                if (items.length) return items;

                // fallback root
                const rRoot = await firebase.database().ref(`${colecao}`).orderByChild('ordem').once('value');
                const itemsRoot = [];
                rRoot.forEach(childSnap => {
                    const v = childSnap.val() || {};
                    itemsRoot.push({
                        id: childSnap.key,
                        ...v,
                        ordem: Number(v.ordem) || 0
                    });
                });
                return itemsRoot;
            } catch (e) {
                console.warn('RTDB read error for', colecao, e);
                return [];
            }
        }

        /* ---------- util: delay default entre 12s e 14s para m√≠dias n√£o-programadas ---------- */
        function defaultMediaDelay() {
            // retorna entre 12000 e 14000 ms
            return 12000 + Math.floor(Math.random() * 2001); // 12000..14000 inclusive
        }

        /* ---------- CARROSSEL CONTROL: inst√¢ncia global com stop() ---------- */
        // window.carrosselInstance = { stop: () => {} } ser√° criado por iniciarCarrossel
        function stopCarrosselIfRunning() {
            try {
                if (window.carrosselInstance && typeof window.carrosselInstance.stop === 'function') {
                    window.carrosselInstance.stop();
                    window.carrosselInstance = null;
                }
            } catch (e) {
                console.warn('Erro ao parar carrossel', e);
            }
        }

        /* ---------- carrossel principal (agora cria carrosselInstance com stop()) ---------- */
        async function iniciarCarrossel(colecao, containerId, empresaId) {
            // garante que qualquer carrossel anterior pare
            stopCarrosselIfRunning();

            const container = document.getElementById(containerId);
            if (!container) return;

            // controller local / retorno para permitir stop
            let cancelled = false;
            let currentTimer = null;

            function limparTimer() {
                if (currentTimer) {
                    clearTimeout(currentTimer);
                    currentTimer = null;
                }
            }

            // registra controller global
            window.carrosselInstance = {
                stop: () => {
                    cancelled = true;
                    limparTimer();
                }
            };

            const itens = await carregarDados(colecao, empresaId);
            if (cancelled) return;

            console.log('Itens carregados para carrossel', colecao, itens);
            if (!itens || !itens.length) {
                container.innerHTML = '<div style="color:#fff;padding:20px">Nenhuma m√≠dia para exibir.</div>';
                return;
            }

            let idx = 0;
            const len = itens.length;

            function gerarEmbedSlidesFromUrl(u, defaultDelayMs = 13000) {
                if (!u) return null;
                try {
                    if (/\/presentation\/d\/e\/[^/]+\/embed/i.test(u) || /\/presentation\/d\/[^/]+\/embed/i.test(u)) {
                        return u;
                    }
                    if (u.includes('/pub')) {
                        let url = new URL(u);
                        if (!url.searchParams.has('start')) url.searchParams.set('start', 'true');
                        if (!url.searchParams.has('loop')) url.searchParams.set('loop', 'true');
                        if (!url.searchParams.has('delayms')) url.searchParams.set('delayms', String(defaultDelayMs));
                        url.pathname = url.pathname.replace(/\/pub$/i, '/embed');
                        return url.toString();
                    }
                    let m = u.match(/\/d\/e\/([a-zA-Z0-9_-]+)/);
                    if (m && m[1]) {
                        return `https://docs.google.com/presentation/d/e/${m[1]}/embed?start=true&loop=true&delayms=${defaultDelayMs}`;
                    }
                    m = u.match(/\/d\/([a-zA-Z0-9_-]+)/);
                    if (m && m[1]) {
                        return `https://docs.google.com/presentation/d/${m[1]}/embed?start=true&loop=true&delayms=${defaultDelayMs}`;
                    }
                } catch (e) {
                    console.warn('gerarEmbedSlidesFromUrl erro', e);
                }
                return null;
            }

            carregarOrientacao(window.empresaId);

            function criarElemento(item) {
                if (!item) return null;

                if (item.texto) {
                    const d = document.createElement('div');
                    d.className = 'fade texto';
                    d.innerHTML = String(item.texto).replace(/\n/g, '<br>');
                    return d;
                }

                let src = String(item.embedUrl || item.url || item.imagem || item.video || '').trim();
                const tipo = String(item.tipo || '').toUpperCase();

                if (src && /docs\.google\.com\/presentation/i.test(src)) {
                    const embed = gerarEmbedSlidesFromUrl(src, Number(item.delayMs || item.delay || 13000));
                    if (embed) src = embed;
                }

                function wrapMedia(el) {
                    const wrap = document.createElement('div');
                    wrap.className = 'media-wrap fade';
                    wrap.style.position = 'absolute';
                    wrap.style.inset = '0';
                    el.style.width = '100%';
                    el.style.height = '100%';
                    el.style.maxWidth = '100%';
                    el.style.maxHeight = '100%';
                    el.style.display = 'block';
                    wrap.appendChild(el);
                    return wrap;
                }

                // google slides handling (mesma l√≥gica)
                if (src && /\/presentation\/d\/e\/[^/]+\/embed/i.test(src)) {
                    const pubSrc = src.replace('/embed', '/pub');
                    const ifr = document.createElement('iframe');
                    ifr.src = pubSrc + (pubSrc.includes('?') ? '' : '?') + 'start=true&loop=true&delayms=13000';
                    ifr.frameBorder = '0';
                    ifr.setAttribute('allowfullscreen', 'true');
                    ifr.style.width = '100%';
                    ifr.style.height = '110%';
                    ifr.style.marginTop = '-40px';
                    ifr.style.border = '0';
                    return wrapMedia(ifr);
                }

                if (src && /docs\.google\.com\/presentation\/d\/.+\/embed/i.test(src)) {
                    const containerIframe = document.createElement('div');
                    containerIframe.style.position = 'relative';
                    containerIframe.style.width = '100%';
                    containerIframe.style.height = '100%';
                    containerIframe.style.background = 'black';

                    const loading = document.createElement('div');
                    loading.style.position = 'absolute';
                    loading.style.top = '50%';
                    loading.style.left = '50%';
                    loading.style.transform = 'translate(-50%, -50%)';
                    loading.style.color = 'white';
                    loading.style.fontSize = '22px';
                    loading.style.fontFamily = 'sans-serif';
                    loading.style.opacity = '0.8';
                    loading.textContent = 'Carregando...';
                    containerIframe.appendChild(loading);

                    const ifr = document.createElement('iframe');
                    ifr.src = src;
                    ifr.style.width = '100%';
                    ifr.style.height = '100%';
                    ifr.style.border = '0';
                    ifr.style.opacity = '0';
                    ifr.allow = 'autoplay; encrypted-media; fullscreen';
                    ifr.setAttribute('allowfullscreen', 'true');
                    containerIframe.appendChild(ifr);

                    setTimeout(() => {
                        ifr.style.transition = 'opacity 700ms ease';
                        ifr.style.opacity = '1';
                        loading.remove();
                    }, 1500);

                    const wrapper = document.createElement('div');
                    wrapper.className = 'media-wrap fade';
                    wrapper.style.position = 'absolute';
                    wrapper.style.inset = '0';
                    wrapper.appendChild(containerIframe);
                    return wrapper;
                }

                // VIDEOS
                if (tipo === 'VIDEO' || /\.mp4($|\?)/i.test(src) || /\.(mp4|webm|ogg|mov)(\?.*)?$/i.test(src)) {
                    const v = document.createElement('video');
                    v.src = src;
                    v.autoplay = true;
                    v.muted = true;
                    v.playsInline = true;
                    v.controls = false;
                    v.preload = 'auto';
                    v.style.objectFit = 'contain';
                    v.style.objectPosition = 'center center';
                    v.style.backgroundColor = 'black';
                    v.style.width = '100%';
                    v.style.height = '100%';
                    v.style.display = 'block';
                    v.style.position = 'relative';

                    const wrapped = wrapMedia(v);

                    v.onended = () => {};
                    v.onerror = () => console.warn('Video erro (elemento):', src);

                    return wrapped;
                }

                // IMAGENS
                if (tipo === 'IMAGEM' || /\.(jpe?g|png|gif|webp|bmp|svg)(\?.*)?$/i.test(src)) {
                    const img = document.createElement('img');
                    img.src = src;
                    img.alt = item.nome || '';
                    img.style.objectFit = 'contain';
                    img.style.objectPosition = 'center center';
                    img.style.display = 'block';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    return wrapMedia(img);
                }

                // IFRAME gen√©rico
                if (/^https?:\/\//i.test(src)) {
                    const ifr = document.createElement('iframe');
                    ifr.src = src;
                    ifr.style.width = '100%';
                    ifr.style.height = '100%';
                    ifr.frameBorder = '0';
                    ifr.allow = 'fullscreen';
                    return wrapMedia(ifr);
                }

                return null;
            }

            function registrarExibicaoSafe(item, ordem) {
                try {
                    const painelId = window.painelId || resolvePainelId();
                    const empId = window.empresaId || 'empresa1';
                    firebase.database().ref(`exibicoes/${empId}/${painelId}`).push({
                        timestamp: new Date().toISOString(),
                        tipo: item.tipo || 'desconhecido',
                        conteudo: (item.nome || item.url || item.imagem || '').slice(0, 120),
                        ordem: ordem
                    });
                } catch (e) {
                    console.warn('N√£o foi poss√≠vel registrar exibi√ß√£o:', e && e.message ? e.message : e);
                }
            }

            async function mostrarProximo() {
                if (cancelled) return;
                limparTimer();

                let tentativas = 0;
                while (tentativas < len) {
                    const item = itens[idx];
                    const el = criarElemento(item);

                    if (el) {
                        // se cancelado entre a cria√ß√£o e aqui, aborta
                        if (cancelled) return;

                        container.innerHTML = '';
                        container.style.background = '#000';

                        el.style.position = 'absolute';
                        el.style.inset = '0';
                        el.style.width = '100%';
                        el.style.height = '100%';

                        container.appendChild(el);

                        registrarExibicaoSafe(item, idx);

                        setTimeout(() => el.classList.add('active'), 30);

                        const videoEl = el.querySelector && el.querySelector('video');

                        if (videoEl) {
                            videoEl.onended = () => {
                                el.classList.remove('active');
                                setTimeout(() => {
                                    idx = (idx + 1) % len;
                                    if (!cancelled) mostrarProximo();
                                }, 380);
                            };

                            videoEl.onerror = () => {
                                console.warn('Video erro, pulando item', item);
                                el.classList.remove('active');
                                setTimeout(() => {
                                    idx = (idx + 1) % len;
                                    if (!cancelled) mostrarProximo();
                                }, 380);
                            };

                            currentTimer = setTimeout(() => {
                                try {
                                    if (!videoEl.readyState || videoEl.readyState < 2) {
                                        console.warn('Video timeout ‚Äî pulando');
                                        el.classList.remove('active');
                                        setTimeout(() => {
                                            idx = (idx + 1) % len;
                                            if (!cancelled) mostrarProximo();
                                        }, 380);
                                    }
                                } catch (e) {
                                    idx = (idx + 1) % len;
                                    if (!cancelled) setTimeout(mostrarProximo, 0);
                                }
                            }, 8000);
                        } else {
                            const tag = (el.tagName || (el.firstElementChild && el.firstElementChild.tagName) || '').toUpperCase();
                            let delay;
                            if (item && (item.delayMs || item.delay)) {
                                delay = Math.max(2000, Number(item.delayMs || item.delay));
                            } else {
                                delay = defaultMediaDelay(); // 12..14s
                            }
                            if (tag === 'IMG' || tag === 'IFRAME' || tag === 'DIV') {
                                if (delay < 12000 || delay > 14000) delay = Math.max(12000, Math.min(14000, delay));
                            }

                            currentTimer = setTimeout(() => {
                                el.classList.remove('active');
                                setTimeout(() => {
                                    idx = (idx + 1) % len;
                                    if (!cancelled) mostrarProximo();
                                }, 360);
                            }, delay);
                        }

                        return;
                    }

                    tentativas++;
                    idx = (idx + 1) % len;
                }

                console.warn('Nenhum item v√°lido encontrado.');
                container.innerHTML = '<div style="color:#fff;padding:20px">Nenhuma m√≠dia v√°lida encontrada.</div>';
            }

            // expose stop on instance to also clear the timer
            window.carrosselInstance.stop = () => {
                cancelled = true;
                limparTimer();
            };

            mostrarProximo();
        }

        /* ---------- frases do rodap√© ---------- */
        async function carregarFrases() {
            const empresaId = window.empresaId || null;
            if (!empresaId) {
                console.warn('carregarFrases: empresaId n√£o definido ainda.');
                return;
            }

            const docs = await carregarDados("frases", empresaId);
            console.log('carregarFrases -> docs:', docs);

            if (!docs || !docs.length) {
                console.warn('Nenhuma frase encontrada para empresaId=', empresaId);
                document.getElementById("fraseRodape").textContent = 'Bem-vindo!';
                return;
            }

            const frases = docs.map(f => f.texto || f.frase || f.mensagem || f.text || f.content || '').filter(Boolean);

            if (!frases.length) {
                console.warn('Frases carregadas, mas nenhum campo reconhecido (texto/frase/mensagem). Veja docs no console.');
                document.getElementById("fraseRodape").textContent = docs[0].texto || docs[0].frase || 'Mensagem dispon√≠vel';
                return;
            }

            let fraseIndex = 0;
            document.getElementById("fraseRodape").textContent = frases[fraseIndex];
            setInterval(() => {
                fraseIndex = (fraseIndex + 1) % frases.length;
                document.getElementById("fraseRodape").textContent = frases[fraseIndex];
            }, 15000);
        }

        /* ---------- rel√≥gio e clima ---------- */
        function atualizarRelogio() {
            const agora = new Date();
            const data = agora.toLocaleDateString();
            const hora = agora.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById("infoRodape").innerHTML = `üìÖ ${data} - üïí ${hora}`;
        }

        const cidades = [{
            nome: "S√£o Paulo",
            query: "Sao+Paulo"
        }, {
            nome: "Santos",
            query: "Santos+SP"
        }, {
            nome: "Guaruj√°",
            query: "Guaruja+SP"
        }, {
            nome: "Bertioga",
            query: "Bertioga+SP"
        }, {
            nome: "S√£o Sebasti√£o",
            query: "Sao+Sebastiao+SP"
        }, {
            nome: "Praia Grande",
            query: "Praia+Grande+SP"
        }, {
            nome: "Mongagu√°",
            query: "Mongagua+SP"
        }, {
            nome: "Ilha Comprida",
            query: "Ilha+Comprida+SP"
        }];
        let cidadeIndex = 0;

        async function atualizarTemperatura() {
            const cidade = cidades[cidadeIndex];
            try {
                const res = await fetch(`https://wttr.in/${cidade.query}?format=%t`);
                const temp = await res.text();
                if (temp.toLowerCase().includes("unknown location")) throw new Error("Indispon√≠vel");
                document.getElementById("cidadeClima").innerText = `üå°Ô∏è ${cidade.nome}: ${temp.replace('+','')}`;
            } catch {
                document.getElementById("cidadeClima").innerText = `‚õÖ ${cidade.nome}: Dados n√£o dispon√≠veis`;
            }
            cidadeIndex = (cidadeIndex + 1) % cidades.length;
        }

        /* util: update URL param without reload */
        function atualizarParametroNaUrl(paramName, paramValue) {
            try {
                if (paramValue === null || paramValue === undefined) return;
                const url = new URL(window.location.href);
                url.searchParams.set(paramName, String(paramValue));
                window.history.replaceState(null, '', url.toString());
            } catch (e) {
                console.warn('atualizarParametroNaUrl erro:', e);
            }
        }

        /* ---------- onAuthStateChanged: resolve empresaId e inicializa ----------
           Observa√ß√£o: se o modal estiver vis√≠vel, N√ÉO iniciamos o carrossel automaticamente. */
        auth.onAuthStateChanged(async user => {
            try {
                const userUid = user ? user.uid : null;
                window.empresaId = await resolveEmpresaIdForPage(userUid);
                window.painelId = resolvePainelId();

                console.log('Painel iniciado', {
                    user: user ? user.email : 'An√¥nimo',
                    empresaId: window.empresaId,
                    painelId: window.painelId
                });

                try {
                    await carregarOrientacao(window.empresaId);
                } catch (err) {
                    console.warn('Erro ao carregar orienta√ß√£o (continuando):', err);
                }

                // se modal est√° sendo mostrado, n√£o iniciar o carrossel automaticamente
                const modal = document.getElementById('uidModal');
                if (modal && modal.classList && modal.classList.contains('show')) {
                    console.log('Modal ativo ‚Äî adiando start do carrossel at√© confirma√ß√£o.');
                } else {
                    iniciarCarrossel('midias', 'superior', window.empresaId);
                    carregarFrases();
                }
            } catch (e) {
                console.error('Erro na inicializa√ß√£o do painel dentro de onAuthStateChanged:', e);
                try {
                    iniciarCarrossel('midias', 'superior', window.empresaId || null);
                    carregarFrases();
                } catch (err) {
                    console.error('Falha ao iniciar carrossel/frases ap√≥s erro:', err);
                }
            }
        });

        function getQueryParam(name) {
            try {
                return new URLSearchParams(window.location.search).get(name);
            } catch {
                return null;
            }
        }

        // ---------- resolveEmpresaIdForPage ----------
        async function resolveEmpresaIdForPage(userUid) {
            const q = getQueryParam('empresa') || getQueryParam('empresaId');
            if (q) {
                localStorage.setItem('empresaId', q);
                atualizarParametroNaUrl('empresaId', q);
                return q;
            }

            const ls = localStorage.getItem('empresaId');
            if (ls) {
                atualizarParametroNaUrl('empresaId', ls);
                return ls;
            }

            if (db && userUid) {
                try {
                    const doc = await db.collection('users').doc(userUid).get();
                    if (doc.exists && doc.data().empresaId) {
                        const empresaId = doc.data().empresaId;
                        localStorage.setItem('empresaId', empresaId);
                        atualizarParametroNaUrl('empresaId', empresaId);
                        return empresaId;
                    }
                } catch (e) {
                    console.warn('firestore users read err', e);
                }
            }

            if (userUid) {
                try {
                    const snap = await firebase.database().ref('usuarios/' + userUid).once('value');
                    const v = snap.val() || {};
                    if (v.empresaId) {
                        localStorage.setItem('empresaId', v.empresaId);
                        atualizarParametroNaUrl('empresaId', v.empresaId);
                        return v.empresaId;
                    }
                } catch (e) {
                    console.warn('RTDB usuarios read err', e);
                }
            }

            const padrao = 'empresa1';
            localStorage.setItem('empresaId', padrao);
            atualizarParametroNaUrl('empresaId', padrao);
            return padrao;
        }

        // ORIENTA√á√ÉO (mantive)
        function aplicarOrientacao(orientacao) {
            if (orientacao === "landscape") document.body.classList.add("rotated");
            else document.body.classList.remove("rotated");
            try {
                localStorage.setItem('painel_orientacao', orientacao);
            } catch (e) {}
            ajustarMidiaParaNaoPassarDoRodape();
        }

        async function carregarOrientacao(empresaId) {
            try {
                if (!empresaId) {
                    const saved = localStorage.getItem('painel_orientacao');
                    if (saved) aplicarOrientacao(saved);
                    return;
                }
                const snap = await firebase.database().ref(`empresas/${empresaId}/painel/orientacao`).once("value");
                const orientacao = snap.val();
                if (orientacao) aplicarOrientacao(orientacao);
            } catch (e) {
                console.warn("Erro ao carregar orienta√ß√£o:", e);
            }
        }

        /* inicializa√ß√£o imediata/cron */
        atualizarRelogio();
        atualizarTemperatura();
        setInterval(atualizarRelogio, 10000);
        setInterval(atualizarTemperatura, 60000);

        // tecla V alterna orienta√ß√£o (ignora inputs)
        document.addEventListener('keydown', async(e) => {
            const tag = (document.activeElement && document.activeElement.tagName) || '';
            if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
            if (e.ctrlKey || e.metaKey || e.altKey) return;
            if (e.key && e.key.toLowerCase() === 'v') {
                const nova = document.body.classList.contains('rotated') ? 'portrait' : 'landscape';
                aplicarOrientacao(nova);
                if (window.empresaId) {
                    firebase.database().ref(`empresas/${window.empresaId}/painel/orientacao`).set(nova).then(() => console.log('Orienta√ß√£o salva no Firebase:', nova)).catch(err => console.warn('Erro ao salvar orienta√ß√£o:', err));
                } else {
                    try {
                        localStorage.setItem('painel_orientacao', nova);
                    } catch (e) {}
                    console.warn('empresaId ausente ‚Äî orienta√ß√£o salva apenas localmente.');
                }
            }
        });

        /* Ajusta m√≠dias para n√£o ficar por tr√°s do rodap√© */
        function ajustarMidiaParaNaoPassarDoRodape() {
            const rodape = document.querySelector('.rodape');
            const midiaContainer = document.querySelector('#superior');
            if (!rodape || !midiaContainer) return;
            const isRotated = document.body.classList.contains('rotated');

            if (!isRotated) {
                const rodapeHeight = rodape.offsetHeight || 60;
                const telaAltura = window.innerHeight;
                const alturaDisponivel = Math.max(0, telaAltura - rodapeHeight);
                midiaContainer.style.paddingBottom = rodapeHeight + 'px';

                document.querySelectorAll('#superior .media-wrap video, #superior .media-wrap img').forEach(midia => {
                    midia.style.height = '';
                    midia.style.width = '';
                    midia.style.maxHeight = '';
                    midia.style.maxWidth = '';
                    midia.style.objectFit = 'contain';
                    midia.style.transform = '';
                    midia.style.maxHeight = alturaDisponivel + 'px';
                    midia.style.maxWidth = '100%';
                    const atualAltura = midia.offsetHeight || midia.getBoundingClientRect().height;
                    if (atualAltura > alturaDisponivel) {
                        const fator = alturaDisponivel / atualAltura;
                        midia.style.transform = `scale(${fator})`;
                    }
                });
            } else {
                const rodapeWidth = rodape.offsetWidth || 60;
                const telaLargura = window.innerWidth;
                const larguraDisponivel = Math.max(0, telaLargura - rodapeWidth);
                midiaContainer.style.paddingLeft = rodapeWidth + 'px';

                document.querySelectorAll('#superior .media-wrap video, #superior .media-wrap img').forEach(midia => {
                    midia.style.height = '';
                    midia.style.width = '';
                    midia.style.maxHeight = '';
                    midia.style.maxWidth = '';
                    midia.style.objectFit = 'contain';
                    midia.style.transform = '';
                    midia.style.maxWidth = larguraDisponivel + 'px';
                    midia.style.maxHeight = '100%';
                    const atualLargura = midia.offsetWidth || midia.getBoundingClientRect().width;
                    if (atualLargura > larguraDisponivel) {
                        const fator = larguraDisponivel / atualLargura;
                        midia.style.transform = `scale(${fator})`;
                    }
                });
            }
        }

        window.addEventListener('load', () => {
            ajustarMidiaParaNaoPassarDoRodape(); /* carregamento controlado pelo modal */
        });
        document.addEventListener('DOMContentLoaded', () => {
            setInterval(ajustarMidiaParaNaoPassarDoRodape, 500);
        });
        window.addEventListener('resize', ajustarMidiaParaNaoPassarDoRodape);

        /* ---------- Modal + inicializa√ß√£o carregamento ---------- */
        const uidModal = document.getElementById('uidModal');
        const empresaIdInput = document.getElementById('empresaIdInput');
        const btnConfirmModal = document.getElementById('btnConfirmModal');
        const btnCancelarModal = document.getElementById('btnCancelarModal');

        function showModal(prefill = '') {
            // limpa o #superior e para carrossel enquanto modal est√° vis√≠vel
            stopCarrosselIfRunning();
            const sup = document.getElementById('superior');
            if (sup) {
                sup.innerHTML = '';
                sup.style.background = '#000';
            }

            if (prefill) empresaIdInput.value = prefill;
            uidModal.classList.add('show');
            setTimeout(() => empresaIdInput.focus(), 80);
        }

        function hideModal() {
            uidModal.classList.remove('show');
        }

        function startLoadingOverlay() {
            const overlay = document.getElementById('carregandoOverlay');
            overlay.style.display = 'flex';
            overlay.setAttribute('aria-hidden', 'false');
            startCarregamentoFrases();
        }

        function startCarregamentoFrases() {
            const frases = [{
                txt: "Iniciando sistema",
                time: 2800
            }, {
                txt: "Estabelecendo Conex√£o Segura",
                time: 2200
            }, {
                txt: "Sincronizando com Database",
                time: 1500
            }, {
                txt: "Atualizando M√≠dias",
                time: 3200
            }, {
                txt: "Preparando interface",
                time: 1500
            }];
            const fraseEl = document.getElementById("frase");
            const pontosWrapper = document.getElementById("pontos");
            const logo = document.getElementById("logoCarregando");
            const overlay = document.getElementById("carregandoOverlay");
            const dots = [document.getElementById("dot1"), document.getElementById("dot2"), document.getElementById("dot3")];
            const pontosSeq = ["", ".", "..", "...", "", ".", "..", "..."];
            let pontosInterval = null;
            let seqIdx = 0;

            function startPontosInterval(speed = 400) {
                clearInterval(pontosInterval);
                pontosInterval = setInterval(() => {
                    const current = pontosSeq[seqIdx];
                    dots.forEach((d, i) => d.style.opacity = i < current.length ? "1" : "0");
                    seqIdx = (seqIdx + 1) % pontosSeq.length;
                }, speed);
            }

            function stopPontosInterval() {
                clearInterval(pontosInterval);
                dots.forEach(d => d.style.opacity = "0");
            }

            let phraseIndex = 0;

            function showPhrase(i) {
                fraseEl.textContent = frases[i].txt;
                startPontosInterval(350);
                setTimeout(() => {
                    fraseEl.classList.add('fadeOutShort');
                    pontosWrapper.classList.add('fadeOutShort');
                    setTimeout(() => {
                        fraseEl.classList.remove('fadeOutShort');
                        pontosWrapper.classList.remove('fadeOutShort');
                        stopPontosInterval();
                        phraseIndex++;
                        if (phraseIndex < frases.length) setTimeout(() => showPhrase(phraseIndex), 200);
                        else finishLoading();
                    }, 420);
                }, frases[i].time);
            }

            function finishLoading() {
                stopPontosInterval();
                fraseEl.textContent = "Painel pronto üöÄ";
                setTimeout(() => {
                    logo.style.transition = 'opacity 700ms ease';
                    logo.style.opacity = '0.12';
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        try {
                            overlay.remove();
                        } catch {}
                    }, 800);
                }, 900);
            }
            setTimeout(() => showPhrase(0), 300);
        }

        btnConfirmModal.addEventListener('click', async() => {
            const val = String(empresaIdInput.value || '').trim();
            if (!val) {
                empresaIdInput.focus();
                return;
            }

            // salva, define global
            localStorage.setItem('empresaId', val);
            window.empresaId = val;
            // esconder modal
            hideModal();

            // iniciar carregamento visual
            startLoadingOverlay();

            // carregar orientacao e s√≥ ent√£o iniciar carrossel com a empresa escolhida
            try {
                await carregarOrientacao(window.empresaId);
            } catch (e) {
                console.warn('carregarOrientacao erro', e);
            }

            // inicia carrossel e frases explicitamente para esta empresa
            iniciarCarrossel('midias', 'superior', window.empresaId);
            carregarFrases();
        });

        btnCancelarModal.addEventListener('click', () => {
            // se cancelar, apenas fecha modal. Mantemos a tela preta (sem iniciar painel)
            hideModal();
            const sup = document.getElementById('superior');
            if (sup) {
                sup.innerHTML = '';
                sup.style.background = '#000';
            }
        });

        empresaIdInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') btnConfirmModal.click();
        });

        // Ao carregar: se j√° existe empresaId salvo => entra direto; se n√£o => mostra modal
        window.addEventListener('DOMContentLoaded', async() => {
            const existing = localStorage.getItem('empresaId');
            if (existing) {
                // inicia direto sem mostrar modal
                window.empresaId = existing;
                startLoadingOverlay();
                try {
                    await carregarOrientacao(window.empresaId);
                } catch (e) {
                    console.warn('carregarOrientacao erro', e);
                }
                iniciarCarrossel('midias', 'superior', window.empresaId);
                carregarFrases();
            } else {
                showModal();
            }
        });

        // helper: apply subtle transform on any media-wrap added later
        (function observeMediaWraps() {
            const root = document.getElementById('superior');
            if (!root || !window.MutationObserver) return;
            const mo = new MutationObserver((mutations) => {
                mutations.forEach(m => {
                    m.addedNodes.forEach(n => {
                        if (n.nodeType === 1 && n.classList && n.classList.contains('media-wrap')) {
                            n.style.transition = 'opacity 480ms cubic-bezier(.22,.95,.26,1), transform 480ms, filter 480ms';
                        }
                    });
                });
            });
            mo.observe(root, {
                childList: true,
                subtree: false
            });
        })();

        // ajuste inicial de qualquer v√≠deo (manter compat)
        document.querySelectorAll('#superior .media-wrap video').forEach(v => {
            v.style.transform = 'translateY(-20px)';
            v.style.zIndex = '1000';
        });
    </script>
</body>

</html>

